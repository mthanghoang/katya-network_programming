University: [ITMO University](https://itmo.ru/ru/)  
Faculty: [FICT](https://fict.itmo.ru)  
Course: [Network programming](https://github.com/itmo-ict-faculty/network-programming)  
Year: 2022/2023  
Group: K34212  
Author: Ekaterina Telegina  
Lab: Lab 4  
Date created:  
Date finished: 
# 
## ЦЕЛЬ РАБОТЫ
Изучить синтаксис языка программирования P4 и выполнить 2 задания обучающих задания от Open network foundation для ознакомления на практике с P4.
## ХОД РАБОТЫ
## 1. Basic Forwarding
Перед выполнением задания с помощью Vagrant была установлена виртуальная машина, на которой имеются все необходимые программы. Подключить к машине под учетной записи p4 и заходить в папку с упраженениями.  
![image](https://user-images.githubusercontent.com/61542577/205453181-bfd5ec5f-70fb-461a-b76c-beddd0d9a71c.png)

Цель данного упражнения — написать программу P4, реализующую базовую переадресацию для ipv4. Идея задачи в том, что коммутатор должен выполнять следующие действия для каждого пакета: обновлять MAC-адреса источника и получателя, уменьшать время жизни (TTL) в заголовке IP и пересылать пакет на соответствующий порт.  
В начале конфигурация в файле basic.p4 отбрасывает все пакеты. Задача закючается в расширении программы для правильной пересылки пакетов.  
Схема связи представлена ниже.  
![image](https://user-images.githubusercontent.com/61542577/205452916-09af2b37-334b-4f7b-8df0-f56a77c239fa.png)

### Запустить первичный код
Скомпилировать файл basic.p4 и включить переключатель в Mininet с помощью команды **make run**, чтобы проверить его поведение. После этого мы должны увидеть командную строку Mininet.  
![image](https://user-images.githubusercontent.com/61542577/205468505-5f73bebc-0534-4582-a501-3dbeddbb509e.png)  

Попробовать пинг между хостами в схеме. Пинг не удался потому что коммутаторы запрограмированы в соответствии с файлом basic.p4, который отбрасывает все пакет по умолчанию.  
![image](https://user-images.githubusercontent.com/61542577/205468595-02d0b912-d0aa-4ab7-8f3a-e8124a875f9b.png)  

Вытий из командной строки Mininet и остановить Mininet.  
![image](https://user-images.githubusercontent.com/61542577/205468690-4075a7d1-b6f6-43f9-8122-e56ed1888d11.png)

### Реализовать пересылки пакетов
1. Добавлены парсер **parse_ethernet**, извелкающий Ethernet заголовок и парсер **parse_ipv4**, извлекающий IPv4 заголовок из пакета.  
При извлечении Ethernet заголовка, если значение поля **etherType** равно 0x800 то следует извлекать внутренний IPv4 заголовок.  
![image](https://user-images.githubusercontent.com/61542577/205469058-73bffbd8-b81d-4ebb-9c70-53714f0cad91.png)

2. После извлечения заголовков нужно обратиться к таблице маршрутов для того, чтобы определить на какой порт пересылать пакет. Это действие выполняется функцией **MyIngress**.

Добавлена логика пересылки пакетов, которая:  
- определяет выходной порт
- обновляет Ethernet адрес назначения
- обновляет Ethernet адрес источника
- уменьшает TTL  
![image](https://user-images.githubusercontent.com/61542577/205469479-2be63125-fcbc-44d0-8821-65b87634cba8.png)

3. Определена таблица, которая читает адрес назначения и вызывает соответственно действие.  
![image](https://user-images.githubusercontent.com/61542577/205469539-92ec6b32-09aa-4ff5-aabe-6817d9fc87c9.png)

4. Применить таблицу, если заголовок ipv4 правильный.  
![image](https://user-images.githubusercontent.com/61542577/205469592-a481a365-b6a6-4d46-96cb-70dccaa2e48d.png)

5. Добавлен депарсер для вставки заголовков в исходящий пакет.  
![image](https://user-images.githubusercontent.com/61542577/205469661-65bd8723-6443-4b04-ac18-67528f0f56fb.png)

### Запустить решение
Запустить Mininet и пробовать пинг между хостами.  
![image](https://user-images.githubusercontent.com/61542577/205469722-f655e00f-d704-4c96-9b52-85bf633740c8.png)

## 2. Basic Tunneling
Цель данного задания - добавить поддержку базового протокола туннелирования на основе предыдущего задания. Определить новый тип заголовка для инкапсуляции IP-пакета и изменить код программы, чтобы она могла определить порт назначения, используя новый заголовок туннеля.  
Схема связи представлена ниже. 
![image](https://user-images.githubusercontent.com/61542577/205469837-02870012-309a-44ce-905a-ec8fb7831009.png)

Перейти на папку второго задания.  
![image](https://user-images.githubusercontent.com/61542577/205469900-ff2eb0e5-82a0-4d47-b06c-5cc908093e5e.png)

Файл **basic_tunnel.p4** является решением предыдущего задания. Полная реализация файла basic_tunnel.p4 сможет выполнять пересылку на основе содержимого пользовательского заголовка инкапсуляции, а также выполнять обычную IP-пересылку, если заголовок инкапсуляции не существует в пакете.

1. Добавлен новый тип заголовка myTunnel_t, который содержит два 16-битных поля: proto_id и dst_id.  
![image](https://user-images.githubusercontent.com/61542577/205469962-33537157-3e17-4718-8655-44dcf703e8ec.png)  
![image](https://user-images.githubusercontent.com/61542577/205469976-5bda5fa8-fcee-4ef9-bc18-6f856bda3e26.png)

2. Обновлен парсер чтобы извлечь либо заголовок myTunnel, либо заголовок ipv4 в зависимости от значения поля etherType в заголовке Ethernet. etherType, соответствующий заголовку myTunnel, равен 0x1212. Парсер также должен извлекать заголовок ipv4 после заголовка myTunnel, если proto_id == 0x800.  
![image](https://user-images.githubusercontent.com/61542577/205470049-3ea32b65-7c6b-4661-930d-cba63f01f31d.png)

3. Создана новая таблица **myTunnel_exact**, которая вызывает функцию myTunnel_forward при совпадении значения поля
 dst_id.  
 ![image](https://user-images.githubusercontent.com/61542577/205470104-a9387e2c-301b-4e97-af25-111f29cae65f.png)


